var J=Object.defineProperty;var X=(n,s,t)=>s in n?J(n,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[s]=t;var j=(n,s,t)=>X(n,typeof s!="symbol"?s+"":s,t);import{R as x,j as e}from"./index-D165w4GE.js";import{S,i as E,C as D,s as w,R as k,u as b,L as d,r as o,E as O,a as y,H as K,v as _,b as Y,P as Q,c as T,d as F,e as H,f as P}from"./pipeline-CLX20hF-.js";const L=new Set,M=new S([],{equals:E}),Z=D.fromObservables([M],([n])=>n.filter(s=>L.has(s.id),{equals:E})),U=new Set,V=new S([],{equals:E}),ee=D.fromObservables([V],([n])=>n.filter(s=>U.has(s.id),{equals:E})),se={$chatgptTabs:M,$geminiTabs:V,$chatgptTabsOpenedByExtensions:Z,$geminiTabsOpenedByExtensions:ee,$settings:new S(w.defaults(),{equals:E}),openedChatgptTabIds:L,openedGeminiTabIds:U};new k({name:"wulala.server",date:!0,getLevel:()=>se.$settings.getSnapshot().loglevel});const R="@/storage/server-settings",I={fetchSettings:async()=>new Promise(n=>{try{chrome.storage.local.get(R,s=>{try{const t=s[R]||"{}",c=JSON.parse(t),i=w.normalize(c);n(i)}catch{n(w.defaults())}})}catch{n(w.defaults())}}),updateSettings:async n=>{const s=JSON.stringify(n);chrome.storage.local.set({[R]:s},()=>{})}},N=({name:n,value:s,minimum:t,maximum:c,onChange:i})=>{const[r,h]=x.useState(String(s)),[l,a]=x.useState(""),m=x.useId(),f=b(g=>{const p=g.target.value||"";h(p),a("")}),u=b(()=>{if(!r){h(""),a("Cannot be empty");return}const g=Number.parseFloat(r);if(isNaN(g)){a("Please enter a valid number");return}if(t!==void 0&&g<t){a(`Value must be at least ${t}`);return}if(c!==void 0&&g>c){a(`Value must be at most ${c}`);return}a(""),h(r),i(g)});return e.jsxs("div",{className:"flex w-full flex-col p-2",children:[e.jsxs("div",{className:"flex w-full flex-row items-center justify-center",children:[e.jsxs("label",{htmlFor:m,className:"mr-2 flex w-56 flex-initial justify-end",children:[n,":"]}),e.jsx("input",{type:"number",id:m,value:r,onChange:f,onBlur:u,className:"mt-1 block flex-auto rounded-md border-gray-300 p-2 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200"})]}),l&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:l})]})};function A(n){const{label:s,options:t,value:c,onChange:i}=n;return e.jsxs("div",{className:"flex w-full max-w-xs items-center gap-4",children:[e.jsx("label",{className:"mb-1 block flex-initial text-sm font-medium text-gray-700",children:s}),e.jsxs("div",{className:"relative flex-auto",children:[e.jsx("select",{value:c,onChange:r=>i(r.target.value),className:"block w-full appearance-none rounded border border-gray-300 bg-white px-4 py-2 pr-8 leading-tight shadow hover:border-gray-400 focus:outline-none",children:t.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))}),e.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700",children:e.jsx("svg",{className:"size-4 fill-current",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"})})})]})]})}const $=({name:n,value:s,onChange:t})=>{const c=x.useId(),[i,r]=x.useState(s),h=b(a=>{const m=a.target.value||"";r(m)}),l=b(()=>{i!==s&&t(i)});return x.useEffect(()=>{r(s)},[s]),e.jsx("div",{className:"flex w-full flex-col p-2",children:e.jsxs("div",{className:"flex w-full flex-row items-center justify-center",children:[e.jsxs("label",{htmlFor:c,className:"mr-2 flex w-56 flex-initial justify-end",children:[n,":"]}),e.jsx("input",{type:"text",id:c,value:i,onChange:h,onBlur:l,className:"mt-1 block w-full rounded-md border-gray-300 p-2 shadow-sm transition duration-150 ease-in-out focus:border-indigo-500 focus:ring focus:ring-indigo-200"})]})})},te=[{label:d.DEBUG,value:d.DEBUG},{label:d.VERBOSE,value:d.VERBOSE},{label:d.INFO,value:d.INFO},{label:d.WARN,value:d.WARN},{label:d.ERROR,value:d.ERROR}],ne=n=>{const{settings:s,onSettingsChange:t}=n,[c,i]=x.useState(!1),[r,h]=x.useState(!0),[l,a]=x.useState(!0),[m,f]=x.useState(!0);return e.jsx(o.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(o.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"ChatGPT Page Settings"}),e.jsx("form",{children:e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(A,{label:"loglevel",value:s.loglevel,options:te,onChange:u=>{t({...s,loglevel:u})}})})}),e.jsxs(o.Accordion,{open:c,children:[e.jsx(o.AccordionHeader,{onClick:()=>i(u=>!u),children:e.jsx("h2",{className:"mb-4 text-lg font-bold",children:"Advanced Settings"})}),e.jsxs(o.AccordionBody,{children:[e.jsxs(o.Accordion,{open:r,children:[e.jsx(o.AccordionHeader,{onClick:()=>h(u=>!u),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"selector"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.selectors).map(([u,g])=>e.jsx($,{name:u,value:g,onChange:p=>{t({...s,selectors:{...s.selectors,[u]:p}})}}))]})})]}),e.jsxs(o.Accordion,{open:l,children:[e.jsx(o.AccordionHeader,{onClick:()=>a(u=>!u),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"delay"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.delay).map(([u,g])=>e.jsx(N,{name:u,value:g,onChange:p=>{t({...s,delay:{...s.delay,[u]:p}})}}))]})})]}),e.jsxs(o.Accordion,{open:m,children:[e.jsx(o.AccordionHeader,{onClick:()=>f(u=>!u),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"timeout"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.timeout).map(([u,g])=>e.jsx(N,{name:u,value:g,onChange:p=>{t({...s,timeout:{...s.timeout,[u]:p}})}}))]})})]})]})]})]})})},le=[{label:d.DEBUG,value:d.DEBUG},{label:d.VERBOSE,value:d.VERBOSE},{label:d.INFO,value:d.INFO},{label:d.WARN,value:d.WARN},{label:d.ERROR,value:d.ERROR}],oe=n=>{const{settings:s,onSettingsChange:t}=n,[c,i]=x.useState(!1),[r,h]=x.useState(!0),[l,a]=x.useState(!0),[m,f]=x.useState(!0);return e.jsx(o.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(o.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"Gemini Page Settings"}),e.jsx("form",{children:e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(A,{label:"loglevel",value:s.loglevel,options:le,onChange:u=>{t({...s,loglevel:u})}})})}),e.jsxs(o.Accordion,{open:c,children:[e.jsx(o.AccordionHeader,{onClick:()=>i(u=>!u),children:e.jsx("h2",{className:"mb-4 text-lg font-bold",children:"Advanced Settings"})}),e.jsxs(o.AccordionBody,{children:[e.jsxs(o.Accordion,{open:r,children:[e.jsx(o.AccordionHeader,{onClick:()=>h(u=>!u),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"selector"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.selectors).map(([u,g])=>e.jsx($,{name:u,value:g,onChange:p=>{t({...s,selectors:{...s.selectors,[u]:p}})}}))]})})]}),e.jsxs(o.Accordion,{open:l,children:[e.jsx(o.AccordionHeader,{onClick:()=>a(u=>!u),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"delay"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.delay).map(([u,g])=>e.jsx(N,{name:u,value:g,onChange:p=>{t({...s,delay:{...s.delay,[u]:p}})}}))]})})]}),e.jsxs(o.Accordion,{open:m,children:[e.jsx(o.AccordionHeader,{onClick:()=>f(u=>!u),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"timeout"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.timeout).map(([u,g])=>e.jsx(N,{name:u,value:g,onChange:p=>{t({...s,timeout:{...s.timeout,[u]:p}})}}))]})})]})]})]})]})})},ae=[{label:d.DEBUG,value:d.DEBUG},{label:d.VERBOSE,value:d.VERBOSE},{label:d.INFO,value:d.INFO},{label:d.WARN,value:d.WARN},{label:d.ERROR,value:d.ERROR}],re=n=>{const{settings:s,onSettingsChange:t}=n,[c,i]=x.useState(!1),[r,h]=x.useState(!0);return e.jsx(o.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(o.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"SBS Page Settings"}),e.jsx("form",{children:e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(A,{label:"loglevel",value:s.loglevel,options:ae,onChange:l=>{t({...s,loglevel:l})}})})}),e.jsxs(o.Accordion,{open:c,children:[e.jsx(o.AccordionHeader,{onClick:()=>i(l=>!l),children:e.jsx("h2",{className:"mb-4 text-lg font-bold",children:"Advanced Settings"})}),e.jsx(o.AccordionBody,{children:e.jsxs(o.Accordion,{open:r,children:[e.jsx(o.AccordionHeader,{onClick:()=>h(l=>!l),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"delay"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.delay).map(([l,a])=>e.jsx(N,{name:l,value:a,onChange:m=>{t({...s,delay:{...s.delay,[l]:m}})}}))]})})]})})]})]})})},ce=[{label:d.DEBUG,value:d.DEBUG},{label:d.VERBOSE,value:d.VERBOSE},{label:d.INFO,value:d.INFO},{label:d.WARN,value:d.WARN},{label:d.ERROR,value:d.ERROR}],ie=n=>{const{settings:s,onSettingsChange:t}=n,[c,i]=x.useState(!1),[r,h]=x.useState(!0);return e.jsx(o.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(o.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"Extension Server Settings"}),e.jsxs("form",{children:[e.jsx("div",{className:"mb-4 flex items-center justify-start",children:e.jsx(A,{label:"loglevel",value:s.loglevel,options:ce,onChange:l=>{t({...s,loglevel:l})}})}),e.jsxs("div",{className:"mb-4 flex items-center justify-start",children:[e.jsx(o.Checkbox,{label:"logheartbeat",checked:s.logheartbeat,onChange:()=>{t({...s,logheartbeat:!s.logheartbeat})}}),e.jsx(o.Checkbox,{label:"logkeepalive",checked:s.logkeepalive,onChange:()=>{t({...s,logkeepalive:!s.logkeepalive})}})]})]}),e.jsxs(o.Accordion,{open:c,children:[e.jsx(o.AccordionHeader,{onClick:()=>i(l=>!l),children:e.jsx("h2",{className:"mb-4 text-lg font-bold",children:"Advanced Settings"})}),e.jsx(o.AccordionBody,{children:e.jsxs(o.Accordion,{open:r,children:[e.jsx(o.AccordionHeader,{onClick:()=>h(l=>!l),children:e.jsx("h3",{className:"mb-4 text-base font-bold",children:"delay"})}),e.jsx(o.AccordionBody,{children:e.jsxs("form",{className:"w-full rounded-lg bg-white p-6 shadow-md",children:[...Object.entries(s.delay).map(([l,a])=>e.jsx(N,{name:l,value:a,onChange:m=>{t({...s,delay:{...s.delay,[l]:m}})}}))]})})]})})]})]})})},de=()=>{const[n,s]=x.useState(!0),[t,c]=x.useState(()=>w.defaults()),i=b(m=>{c(m),I.updateSettings(m)}),r=b(m=>{const f={...t,chatgpt:m};i(f)}),h=b(m=>{const f={...t,gemini:m};i(f)}),l=b(m=>{const f={...t,localhost:m};i(f)}),a=b(m=>{const f={...t,...m};i(f)});return x.useEffect(()=>{let m=!1;return I.fetchSettings().then(f=>{m||(c(f),s(!1))}),()=>{m=!0}},[]),n?e.jsx("div",{children:e.jsx("span",{children:"loading..."})}):e.jsxs("div",{className:"flex flex-col items-center gap-4 p-2",children:[e.jsx(ie,{settings:t,onSettingsChange:a}),e.jsx(ne,{settings:t.chatgpt,onSettingsChange:r}),e.jsx(oe,{settings:t.gemini,onSettingsChange:h}),e.jsx(re,{settings:t.localhost,onSettingsChange:l})]})};class ue{constructor(s){j(this,"from");j(this,"name");j(this,"passthrough");j(this,"reporter");j(this,"onmessage");j(this,"_port");const{from:t,name:c,passthrough:i,reporter:r,onmessage:h}=s;this.from=t,this.name=c,this.passthrough=i,this.reporter=r,this.onmessage=h,this._port=null}watch_reconnect(){const{reporter:s}=this;chrome.runtime.onMessage.addListener(t=>{if(t.from===O.SERVER)switch(s.debug(`--> ${t.from} - ${t.type}:`,{message:t}),t.type){case y.RECONNECT:{this.connect(!0);break}default:s.error("Unknown message:",t)}})}connect(s){const{name:t,passthrough:c,reporter:i,onmessage:r}=this;if(this._port){if(!s)return this._port;try{this._port.disconnect()}catch(l){i.error("Failed to disconnect. error:",l)}this._port=null}const h=chrome.runtime.connect(void 0,{name:t});return h.onDisconnect.addListener(()=>{i.info(`Port ${h.name} disconnected.`),this._port=null}),h.onMessage.addListener(l=>{i.debug(`--> ${l.from} - ${l.type}:`,{pack:l}),r&&r(l),c&&window.postMessage({action:K.FROM_EXTENSION_CONTEXT,payload:l},"*")}),i.info("connect on port:",h.name),this._port=h,h}heartbeat(s){const{from:t}=this,c={mid:_(),index:0,total:1,from:t,type:y.HEARTBEAT,payload:JSON.stringify({uuid:s})};this.send(c)}send(s){const{reporter:t}=this,c=this.connect(!1);try{c.postMessage(s)}catch(i){t.error("Failed to send pack:",{pack:s,error:i}),t.info("Trying to reconnect..."),this.connect(!0).postMessage(s)}}}const B={port:"popup",fetchChatgptTabs:"popup.fetchChatgptTabs",fetchGeminiTabs:"popup.fetchGeminiTabs",fetchOpenedChatgptTabs:"popup.fetchOpenedChatgptTabs",fetchOpenedGeminiTabs:"popup.fetchOpenedGeminiTabs"},C=new k({name:"wulala.popup",date:!0,getLevel:()=>d.DEBUG}),q=new ue({from:O.POPUP,name:B.port,passthrough:!1,reporter:C,onmessage:n=>{if(typeof n.mid!="string"||typeof n.type!="string"||!Y.has(n.type)){C.error("Unknown event from dom context:",{pack:n});return}G.receive(n)}});q.watch_reconnect();const G=new Q({from:O.POPUP,reporter:C,writeMessagePack:async n=>{q.send(n)},handleMessage:async n=>{const s=n,t=v.get(s.uuid);if(!t){C.error("Cannot find the state with the given uuid:",{message:s});return}switch(s.code){case T.SUCCEED:{t.next({loading:!1,code:s.code,data:s.data,error:null});break}case T.FAILED:{C.error("Request failed:",{message:s}),t.next({loading:!1,code:s.code,data:null,error:s.error??null});break}default:C.error("Invalid message:",{message:s});break}}}),v=new Map,W=n=>{const s=_(),t=(v.has(s)||v.set(s,new S({loading:!1,code:null,data:null,error:null})),v.get(s)),c={uuid:s,from:O.POPUP,type:n.type,data:n.data};return G.write(c),t.next({loading:!0,code:null,data:null,error:null}),t},z=n=>{const s=x.useMemo(()=>(v.has(n)||v.set(n,new S({loading:!1,code:null,data:null,error:null})),v.get(n)),[n]),t=x.useCallback(c=>{const i={uuid:n,from:O.POPUP,type:c.type,data:c.data};return G.write(i),s.next({loading:!0,code:null,data:null,error:null}),s},[s,n]);return{state:s,request:t}},he=n=>{const{state:s,request:t}=z(B.fetchOpenedChatgptTabs),{loading:c,code:i,data:r,error:h}=F(s),l=x.useCallback(()=>{t({type:y.FETCH_CHATGPT_TABS,data:{filter:n}})},[t,n]);x.useEffect(()=>{l()},[l]);const a=(r==null?void 0:r.tabs)??[];return{loading:c,code:i,tabs:a,error:h,refresh:l}},me=()=>x.useCallback(s=>{const t=W({type:y.CLOSE_CHATGPT_TAB,data:{tabid:s}});return new Promise((c,i)=>{let r=!1;const h=a=>{r||(r=!0,c(a))},l=a=>{r||(r=!0,i(a))};t.subscribe(new H({onNext:a=>{a.error?l(a.error):a.code===T.SUCCEED?h(!0):h(!1)},onDispose:()=>l("[useCloseChatgptTab] The state has been disposed.")}))})},[]),xe=()=>x.useCallback(s=>{const t=W({type:y.CLOSE_GEMINI_TAB,data:{tabid:s}});return new Promise((c,i)=>{let r=!1;const h=a=>{r||(r=!0,c(a))},l=a=>{r||(r=!0,i(a))};t.subscribe(new H({onNext:a=>{a.error?l(a.error):a.code===T.SUCCEED?h(!0):h(!1)},onDispose:()=>l("[useCloseGeminiTab] The state has been disposed.")}))})},[]),ge=n=>{const{state:s,request:t}=z(B.fetchOpenedGeminiTabs),{loading:c,code:i,data:r,error:h}=F(s),l=x.useCallback(()=>{t({type:y.FETCH_GEMINI_TABS,data:{filter:n}})},[t,n]);x.useEffect(()=>{l()},[l]);const a=(r==null?void 0:r.tabs)??[];return{loading:c,code:i,tabs:a,error:h,refresh:l}},fe=()=>{const{tabs:n,refresh:s}=he("openedByExtension"),{tabs:t,refresh:c}=ge("openedByExtension"),i=me(),r=xe(),h=b(a=>{i(a).then(()=>s()).catch(m=>console.error("Failed to close chatpgt tab",m))}),l=b(a=>{r(a).then(()=>c()).catch(m=>console.error("Failed to close gemini tab",m))});return e.jsx("div",{className:"flex w-full flex-col items-center gap-4 p-2",children:e.jsx(o.Card,{className:"my-4 w-full max-w-[40rem] flex-auto",children:e.jsxs(o.CardBody,{children:[e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"ChatGPT Tabs"}),e.jsx("div",{className:"w-full",children:n.length>0?e.jsxs(o.List,{children:[...n.map(a=>e.jsxs(o.ListItem,{className:"flex justify-between",children:[e.jsxs("div",{className:"flex flex-auto gap-4",children:[e.jsx("span",{children:a.id}),e.jsx("span",{children:a.title})]}),e.jsx("button",{className:"flex-auto",onClick:m=>{m.stopPropagation(),m.preventDefault(),h(a.id)},children:e.jsx(P,{})})]}))]}):e.jsx("div",{className:"flex w-full justify-start",children:"Empty"})}),e.jsx("h1",{className:"mb-4 text-2xl font-bold",children:"Gemini Tabs"}),e.jsx("div",{className:"w-full",children:t.length>0?e.jsxs(o.List,{children:[...t.map(a=>e.jsxs(o.ListItem,{className:"flex justify-between",children:[e.jsxs("div",{className:"flex flex-auto gap-4",children:[e.jsx("span",{children:a.id}),e.jsx("span",{children:a.title})]}),e.jsx("button",{className:"flex-auto",onClick:m=>{m.stopPropagation(),m.preventDefault(),l(a.id)},children:e.jsx(P,{})})]}))]}):e.jsx("div",{className:"flex w-full justify-start",children:"Empty"})})]})})})},pe=()=>e.jsxs("div",{className:"size-full bg-gray-50",children:[e.jsx("div",{className:"flex w-full flex-col gap-4",children:e.jsx(fe,{})}),e.jsx("div",{className:"flex w-full flex-col gap-4",children:e.jsx(de,{})})]});pe.displayName="PopupPage";export{pe as default};
